<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>考勤系统</title>
  <link rel="stylesheet" href="../layui/css/layui.css">
  <style>
    .meeting{
        border:solid;
        border-width: 1px;
        width:100%;
        height:80%
    }
    
</style>
</head>
<body>
<div class="layui-layout layui-layout-admin">
  <div class="layui-header">
    <div class="layui-logo layui-hide-xs layui-bg-black">智慧考勤系统</div>
    <!-- 头部区域（可配合layui 已有的水平导航） -->
    <ul class="layui-nav layui-layout-left">
      <!-- 移动端显示 -->
      <li class="layui-nav-item layui-show-xs-inline-block layui-hide-sm" lay-header-event="menuLeft">
        <i class="layui-icon layui-icon-spread-left"></i>
      </li>
      <li class="layui-nav-item layui-hide-xs"><button  onclick="window.location.href='/admin/sign'" class="layui-btn layui-btn-radius layui-btn-lg">签到打卡</button></li>
    </ul>
    <ul class="layui-nav layui-layout-right">
      <li class="layui-nav-item layui-hide layui-show-md-inline-block">
        <li class="layui-nav-item"><input type="text" class="layui-input" id="test1"></li>
        <li class="layui-nav-item"><a href="#">个人信息</a>
        <dl class="layui-nav-child">
			<dd><a href="/admin/info">基本信息</a></dd>
            <dd><a href="/">注销</a></dd>
        </dl></li>
    </ul>
  </div>

  <div class="layui-side layui-bg-black" id="navigation">
    <div class="layui-side-scroll">
      <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
      <ul class="layui-nav layui-nav-tree" lay-filter="test">
        <li class="layui-nav-item">
          <a class="homepage" href="/admin/home">首页</a></li>
                  <li class="layui-nav-item"><a href="/admin/manage">职员管理</a></li>
        <li class="layui-nav-item"><a href="/admin/check">考勤记录</a></li>
        <li class="layui-nav-item"><a href="/admin/oa">请假管理</a></li>
        <li class="layui-nav-item layui-nav-itemed"><a href="/admin/meet">视频会议</a></li>
      </ul>
    </div>
  </div>

  <div class="layui-body">
    <!-- 播放视频部分 -->
    <div class="meeting" >
      <audio id="localAudio" controls autoplay></audio>
		<video id="localVideo" autoplay="true" playsinline="true"></video>
		<video id="localDisplay" autoplay="true" playsinline="true"></video>
        <button id="startmeeting" onclick="start()" type="button" class="layui-btn layui-btn-lg layui-btn-radius layui-btn-primary layui-border-black" style="margin:300px 800px">开始会议</button>
    </div>
    <!-- 工具部分 -->
    <div class="tool" >
        <button class="layui-btn layui-btn-radius layui-btn-primary"><i class="layui-icon layui-icon-mike" style="font-size: 30px;"></i></button>
        <button class="layui-btn layui-btn-radius layui-btn-primary"><i class="layui-icon layui-icon-mute" style="font-size: 30px;"></i></button>
        <button class="layui-btn layui-btn-radius layui-btn-primary"><i class="layui-icon layui-icon-pause" style="font-size: 30px;"></i></button>
        <button style="margin-left:1300px" class="layui-btn layui-btn-radius layui-btn-primary"><i class="layui-icon layui-icon-logout" style="font-size: 30px;"></i></button>
    </div>
  </div>


  <div class="layui-footer">
    <!-- 底部固定区域 -->
    欢迎使用智慧考勤系统！
  </div>
</div>
<script src="../layui/layui.js"></script>
<script>
//JS
layui.use(['element', 'layer', 'util'], function(){
  var element = layui.element
  ,layer = layui.layer
  ,util = layui.util
  ,$ = layui.$;

  //头部事件
  util.event('lay-header-event', {
    menuRight: function(){
      layer.open({
        type: 1
        ,content: '<div style="padding: 15px;">处理右侧面板的操作</div>'
        ,area: ['260px', '100%']
        ,offset: 'rt' //右上角
        ,anim: 5
        ,shadeClose: true
      });
    }
  });
});

var time=new Date();
         var date = time.getFullYear() + '-' + (time.getMonth() + 1) + '-' + time.getDate()
         console.log(date);


layui.use('laydate', function(){
  var laydate = layui.laydate;

  //执行一个laydate实例
  laydate.render({
    elem: '#test1' //指定元素
    ,type: 'date'
    ,value: new Date(new Date())
  });
});

layui.use('table', function(){
  var table = layui.table;


});
</script>

<script type="text/javascript">
		var pc = null;
		var localVideo = document.querySelector("video#localVideo");
		var localAudio = document.querySelector('#localAudio');
		var localDisplay = document.querySelector('#localDisplay');
		localAudio.style.display = 'none';

		function negotiate() {
			return pc.createOffer().then(function (offer) {
				return pc.setLocalDescription(offer);
			}).then(function () {
				// wait for ICE gathering to complete
				return new Promise(function (resolve) {
					if (pc.iceGatheringState === 'complete') {
						resolve();
					} else {
						function checkState() {
							if (pc.iceGatheringState === 'complete') {
								pc.removeEventListener('icegatheringstatechange', checkState);
								resolve();
							}
						}
						pc.addEventListener('icegatheringstatechange', checkState);
					}
				});
			}).then(function () {
				var offer = pc.localDescription;
				return fetch('/offer', {
					body: JSON.stringify({
						sdp: offer.sdp,
						type: offer.type,
					}),
					headers: {
						'Content-Type': 'application/json'
					},
					method: 'POST'
				});
			}).then(function (response) {
				return response.json();
			}).then(function (answer) {
				return pc.setRemoteDescription(answer);
			}).catch(function (e) {
				alert(e);
			});
		}


		async function start() {
			startmeeting.style.display = 'none';
			await navigator.mediaDevices.getUserMedia({
				audio: true,
				video: true,
			}).then(stream => {
				localAudio.srcObject = stream;
				localVideo.srcObject = stream;
				//localAudio.addEventListener('loadedmetadata', () => {
				//localAudio.play();
				//});
			});

			var config = {
				sdpSemantics: 'unified-plan',
				iceServers: [{
					urls: ['stun:stun.l..com:19302'],
				}]
			};

			pc = new RTCPeerConnection(config);

			localAudio.srcObject.getAudioTracks().forEach(track => {
				pc.addTrack(track);
			});

			localVideo.srcObject.getVideoTracks().forEach(track => {
				pc.addTrack(track);
			});


			pc.addEventListener('trackA', function (evt) {
				console.log("receive server audio");
				if (evt.track.kind == 'audio') {
					localAudio.srcObject = evt.streams[0];
				}
			});

			pc.addEventListener('trackV', function (evt) {
				console.log("receive server video");
				if (evt.track.kind == 'video') {
					localVideo.srcObject = evt.streams[0];
				}
			});

			negotiate();
		}



		async function share() {
			await navigator.mediaDevices.getDisplayMedia({
				video: true
			}).then(stream => {
				localDisplay.srcObject = stream;
				localDisplay.addEventListener('loadedmetadata', () => {
					localDisplay.play();
				});
			});

			var config = {
				sdpSemantics: 'unified-plan',
				iceServers: [{
					urls: ['stun:stun.l..com:19302'],
				}]
			};

			pc = new RTCPeerConnection(config);

			localDisplay.srcObject.getVideoTracks().forEach(track => {
				pc.addTrack(track);
			});

			//	document.getElementById('start').style.display = 'none';
			negotiate();
			//	document.getElementById('stop').style.display = 'inline-block';
		}


		function stop() {
			setTimeout(function () {
				pc.close();
			}, 500);
		}

		function stopAudio() {
			console.log(stoA.src);
			if (stoA.src=="http://127.0.0.1:8080/images/mic_close.png"){
				setTimeout(function () {
					//localAudio.srcObject.getTracks().forEach(track => track.stop());
					localAudio.srcObject = null;
				}, 100);
				stoA.src = "../images/mic_on.png";
			}else{
			pc.addEventListener('track', function (evt) {
				console.log("receive server video");
				if (evt.track.kind == 'video') {
					localVideo.srcObject = evt.streams[0];
				}
			});
				stoA.src = "../images/mic_close.png";
			}
		}

		function stopVideo() {
			setTimeout(function () {
				//localVideo.srcObject.getTracks().forEach(track => track.stop());
				localVideo.srcObject = null;
			}, 500);
			stoV.src = "../images/cam_on.png"
		}

		function stopShare() {
			setTimeout(function () {
				localVideo.srcObject.getTracks().forEach(track => track.stop());
				localVideo.srcObject = null;
			}, 500);
			//staS.src = "../images/cam_on.png"
		}
	</script>


</body>
</html>